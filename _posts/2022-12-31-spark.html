---
layout: post
title: Spark数据湖
excerpt: Spark数据湖
---
<div id="outline-container-orgf82997e" class="outline-2">
<h2 id="orgf82997e"><span class="section-number-2">1.</span> Spark数据湖</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org3c09445" class="outline-3">
<h3 id="org3c09445"><span class="section-number-3">1.1.</span> 如果在spark中使用iceberg</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">
<pre class="src src-bash">spark-shell --packages org.apache.iceberg:iceberg-spark-runtime-3.3_2.12:1.1.0 \
            --conf spark.sql.extensions=org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions \
            --conf spark.sql.catalog.spark_catalog=org.apache.iceberg.spark.SparkSessionCatalog \
            --conf spark.sql.catalog.spark_catalog.type=hive \
            --conf spark.sql.catalog.local=org.apache.iceberg.spark.SparkCatalog \
            --conf spark.sql.catalog.local.type=hadoop \
            --conf spark.sql.catalog.local.warehouse=$PWD/warehouse \
            --conf spark.driver.extraJavaOptions=-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=4747
</pre>
</div>
</div>
</div>

<div id="outline-container-orga966231" class="outline-3">
<h3 id="orga966231"><span class="section-number-3">1.2.</span> spark写流程</h3>
<div class="outline-text-3" id="text-1-2">
<ul class="org-ul">
<li>V2TableWriteExec in WriteToDataSourceV2Exec.scala</li>
</ul>
</div>
</div>

<div id="outline-container-org6402237" class="outline-3">
<h3 id="org6402237"><span class="section-number-3">1.3.</span> <span class="todo TODO">TODO</span> 支持分层的数据湖格式</h3>
<div class="outline-text-3" id="text-1-3">
<ul class="org-ul">
<li>基于lsm结构组织文件
<ul class="org-ul">
<li>第一层采用tiering的方式排布</li>
<li>第二层以上采用leveling的方式组织</li>
<li>行是否唯一</li>
</ul></li>
<li>共享索引结构
<ul class="org-ul">
<li>通过MVCC支持一写多读</li>
<li>对第一层的数据进行索引
<ul class="org-ul">
<li>使用什么列来做索引内容</li>
<li>索引指针是什么</li>
</ul></li>
<li>二层索引
<ul class="org-ul">
<li>第一层range索引</li>
<li>第二层文件内索引</li>
</ul></li>
</ul></li>
<li>读数据
<ul class="org-ul">
<li>逐层读取数据，再做数据合并</li>
<li>多个partition并发查询，从第一层过滤自己感兴趣的数据</li>
</ul></li>
<li>写数据
<ul class="org-ul">
<li>先写到第一层，再聚合起来下降到下层</li>
<li>写类型
<ul class="org-ul">
<li class="on"><code>[X]</code> insert into</li>
<li class="off"><code>[&#xa0;]</code> merge into</li>
<li class="off"><code>[&#xa0;]</code> insert overwrite</li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
</div>
